#{extends 'main.html' /}
#{set title:'Template Bulkbank' /}

#{set 'moreStyles'}
<link rel="stylesheet" href="/public/stylesheets/pages/validated-forms.css">
#{/set}

#{set 'moreScripts'}
<script src="/public/javascripts/jquery.validate.min.js" type="text/javascript"></script>
<script src="/public/javascripts/form.validation.js"></script>
<script>
    $(document).ready(function() {
        #{if template }
            $("#template-form").hide();
            $.ajax({
                url:  '/bulkBank',
                type:'POST',
                data: {'url': '/templateBulkBank/${template}'},
                success:function(result){
                    var result =  $.parseJSON(result);
                    $("#name").val(result.name);
                    $(".page-header h1").html(result.name);
                    $("#adults").val(result.adults);
                    $("#children").val(result.children);
                    $("#rate").val(result.rate);
                    $("#observations").val(result.observations);
                    load_sunset_hotels("/hotel", $("#hotel"), result.clubId);
                    var unit= result.unit? result.unit.id : '';
                    var split= result.split? result.split.id : '';
                    load_catalog_bulbank("/hotelUnits?hotelId="+result.clubId, $("#unit"), unit);
                    load_catalog_bulbank("/hotelUnits?hotelId="+result.clubId, $("#split"), split);
                    #{if isOta==1}
                    var callCenter= result.callCenter ? result.callCenter.id : null;
                    load_catalog("/callCenter/list?segments=4,26", $("#callCenter"), callCenter);
                    #{/if}
                    var plan= result.plan ? result.plan.id :'';
                    load_mealplan(plan, '/mealplans/all');
                    $(".sk-chasing-dots").hide();
                    $("#template-form").show();

                },
                error: function(err){
                    showError("error" + err);
                }
            });
            //Cargar datos de template

        #{/if}
        #{else}
            load_sunset_hotels("/hotel", $("#hotel"), 1);
            load_catalog_bulbank("/hotelUnits?hotelId=1", $("#unit, #split"), "");
            #{if isOta==1}
            load_catalog("/callCenter/list?segments=4,26", $("#callCenter"), 1);
            #{/if}
            load_mealplan("", '/mealplans/all');
            $(".sk-chasing-dots").hide();
        #{/else}
        $( "#hotel" ).change(function() {
            var hotel=$('option:selected', this).attr("data-hotel");
            load_catalog_bulbank("/hotelUnits?hotelId="+hotel, $("#unit, #split"));
        });
        $("#template-form").validate({
            rules: {
                rate:{
                    required: true,
                    number: true
                }
            },
            submitHandler: function (form) {
                var $submitButton = $('#submit');
                $submitButton.attr("disabled", true).val("creating....");
                data = {
                    name: $("#name").val(),
                    clubId: $("#hotel").val(),
                    unitId: $("#unit").val(),
                    splitId: $("#split").val(),
                    mealPlanId: $("#meal-plan").val(),
                    callCenterId: $("#callCenter").val(),
                    adults: $("#adults").val(),
                    rate: $("#rate").val(),
                    children: $("#children").val(),
                    observations: $("#observations").val()
                }
                var url=$("#templateId").val()!="" ? '/templateBulkbank/${template}': '/createTemplate';
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: data,
                    success: function(msg){
                        result = JSON.parse(msg);
                        console.log(result);
                        if(result.name){
                            $("#id-value").val(result.id);
                            $("#templateName").val(result.name);
                            $("#redirect").submit();
                        }else{
                            showError("Hubo un error en la aplicación");
                        }
                        $submitButton.attr("disabled", false).val("Save");

                    }, error: function(result){
                        showError("Hubo un error en la aplicación");
                        $submitButton.attr("disabled", false).val("Save");
                    }
                });

            }
        });
    });
</script>
#{/set}

<form action="/templateBulkbank"  method='POST' id='redirect'>
    <input name="id" type="hidden" id="id-value" value="${template}" />
    <input id="templateName" name="name" type="hidden" value="" />
    <input id="mode" type="hidden" name="mode" value="#{if editMode}edit#{/if}#{else}create#{/else}"/>
</form>

<input id="id-value" type="hidden" value="${brokerId}"/>
<div class="col-lg-12 page-header">
    <div class="row">
        <div class="col-lg-12">
            <div class="row">
                <h1>&{'new'} Template Bulk Bank</h1>
            </div>
        </div>
    </div>
</div>
<!-- /.row -->
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading" id="brokers-panel-title">
            &{'new'}
            </div>
            <div class="panel-body">
                <div class="row">
                        <div class="sk-chasing-dots">
                            <div class="sk-child sk-dot1"></div>
                            <div class="sk-child sk-dot2"></div>
                        </div>
                        <form id="template-form" role="form" action="" method="post">
                            <div class="col-sm-6">
                                <input id="templateId" name="templateId" type="hidden" value="${template}"/>
                                <div class="form-group">
                                    <label>&{'name'}</label>
                                    <input id="name" type="text" name="name" class="form-control" required/>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Hotel</label>
                                    <select  class="form-control" name="hotel" id="hotel" required></select>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Unit</label>
                                    <select  class="form-control" name="unit" id="unit" required></select>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Split</label>
                                    <select  class="form-control" name="split" id="split"></select>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Plan</label>
                                    <select  class="form-control" name="meal-plan" id="meal-plan" required> </select>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <label>Rate</label>
                                <input id="rate" class="form-control" type="text" name="rate" maxlength="6" min="0" max="99" required />
                            </div>
                            <div class="clearfix"></div>
                            <div class="col-sm-6">
                                <label>Adults</label>
                                <input id="adults" class="form-control" type="number" maxlength="2" min="0" max="99" required>
                            </div>
                            <div class="col-sm-6">
                                <label>Children</label>
                                <input id="children" class="form-control" type="number" maxlength="2" min="0" max="99" required />
                            </div>
                            #{if isOta==1}
                            <div class="clearfix"></div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Call Center</label>
                                    <select  class="form-control" name="callCenter" id="callCenter" required></select>
                                </div>
                            </div>
                            #{/if}
                            <div class="clearfix"></div><br />
                            <div class="form-group">
                                <label class="col-sm-12">Observations</label>
                                <div class="clearfix"></div>
                                <div class="col-sm-11">
                                    <textarea class="form-control col-sm-10" maxlength="500" id="observations" rows="3" data-length="2"/></textarea>
                                </div>
                                <div id="cont" class="col-sm-1">500</div>
                            </div>
                            <div class="clearfix"></div><br />
                            <div class="col-sm-6">
                                #{if brokerId }
                                    #{secure.check 'EditarTemplateBulkBank'}
                                        <input type="submit" id="submit" class="btn btn-primary" value="&{'save'}">&nbsp; &{'or'}
                                    #{/secure.check}
                                #{/if}
                                #{else }
                                    #{secure.check 'CrearTemplateBulkBank'}
                                        <input type="submit" id="submit" class="btn btn-primary" value="&{'save'}">&nbsp; &{'or'}
                                    #{/secure.check}
                                #{/else}
                                <input type="submit" id="submit" class="btn btn-primary" value="&{'save'}">&nbsp; &{'or'}
                                <a href="/brokers/${masterBrokerId}" class="btn">&{'cancel'}</a>
                            </div>
                        </form>

                    <!-- /.col-lg-6 (nested) -->

                </div>
                <!-- /.row (nested) -->
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->
    </div>
</div>